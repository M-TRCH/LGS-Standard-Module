# การอัพเดท Firmware

ไฟล์นี้อธิบายขั้นตอนการอัพเดท firmware ลงบอร์ด STM32F103 โดยใช้ STM32Cube Programmer แบ่งเป็น 3 ส่วน

---

## ส่วนที่ 1: อัพโหลด Firmware ครั้งแรก (Initial Programming)

เป็นการอัพโหลดครั้งแรกหลังจากผลิตบอร์ด ต้องล้างหน่วยความจำและตรวจสอบก่อน

### 1.1 เตรียมไฟล์ Firmware

1. หาไฟล์ firmware (.bin) ที่ต้องการอัพโหลด ชื่อไฟล์ตัวอย่าง:
   ```
   firmware_stm32f103_v2.0.2_2025-12-17.bin
   firmware_stm32f103_v2.0.1_2025-11-27.bin
   firmware_stm32f103_v1.0.0_2025-08-28.bin
   ```

2. ตรวจสอบว่าไฟล์มี extension `.bin` และจดบันทึก **Version** และ **Date** สำหรับติดตามรุ่น

### 1.2 เปิด STM32Cube Programmer และ Browse ไฟล์

1. เปิด **STM32Cube Programmer**
2. ไปที่เมนู **Erasing & Programming**
3. คลิกปุ่ม **Browse** เพื่อเลือกไฟล์ firmware
4. เลือกไฟล์ `.bin` ที่เตรียมไว้ในขั้นที่ 1.1
5. ตรวจสอบ **Start Address** ว่าแสดง `0x08000000` (ถ้าไม่ถูกต้องให้แก้ไข)

### 1.3 ตั้งค่า Options ในเมนู **Download**

ให้ **Check (เปิด)** ตัวเลือกต่อไปนี้:

| Option | คำอธิบาย |
|--------|---------|
| ✓ **Verify program** | ตรวจสอบความถูกต้องของข้อมูลหลังอัพโหลด |
| ✓ **Full Flash memory checksum** | ตรวจสอบ checksum ของไฟล์ทั้งหมด |
| ✓ **Run after program** | ให้ MCU รันทันทีหลังอัพโหลดเสร็จ |

> **Start Address**: ตรวจสอบว่าตั้งค่า `0x08000000` ถ้าไม่ถูกต้องให้กรอกเอง

### 1.4 ไปที่เมนู Automatic Mode
ให้ **Check (เปิด)** ตัวเลือกต่อไปนี้:

| Option | คำอธิบาย |
|--------|---------|
| ✓ **Full chip erase** | ล้างหน่วยความจำทั้งชิป (ลบโปรแกรมเก่า) |
| ✓ **Download file** | อัพโหลดไฟล์ firmware ใหม่ |

### 1.5 คลิก "Start Auto Download"

1. คลิกปุ่ม **"Start automatic mode"** 
2. รอให้ STM32Cube Programmer แสดง progress bar

### 1.6 เสียบสายเชื่อมต่อ รีเซต และตรวจสอบ

1. **เสียบสายเชื่อมต่อ** ระหว่างบอร์ดกับคอมพิวเตอร์ (ST-Link)
2. รอจนกว่า STM32Cube Programmer แสดง **100% Complete**
3. หลังจากสำเร็จ ให้คลิกปุ่ม **Reset** (ปุ่มรีเซตบนบอร์ด)
4. รอจนกว่าไฟ **RUN LED** เริ่มกระพริบ 

> **หมายเหตุ**: หากอัพโหลดสำเร็จ MCU จะเข้าโหมดทำงาน (RUN mode) โดยอัตโนมัติ

---

## ส่วนที่ 2: อัพโหลด Firmware ครั้งถัดไป (Subsequent Updates)

เมื่ออัพโหลดครั้งแรกสำเร็จแล้ว การอัพโหลดครั้งต่อไปจะง่ายขึ้น

### 2.1 เตรียมไฟล์ Firmware เวอร์ชันใหม่

ทำตามเหมือน [ส่วนที่ 1.1](#11-เตรียมไฟล์-firmware)

### 2.2 Browse ไฟล์ใน Automatic Mode (เหมือนขั้นที่ 1.2)

ทำตามเหมือน [ส่วนที่ 1.2](#12-เปิด-stm32cube-programmer-และ-browse-ไฟล์) แต่ข้ามขั้นที่ 1.3 และ 1.4

### 2.3 ตั้งค่า Automatic Mode (เฉพาะ Download)

1. ไปที่เมนู **Automatic Mode**
2. ให้ **Check (เปิด)** เฉพาะตัวเลือก:

| Option | สถานะ |
|--------|-------|
| ✓ **Download file** | เปิด (อัพโหลดไฟล์ใหม่) |

> **ความแตกต่างจากครั้งแรก**: ไม่เปิด "Full chip erase" เพื่อเก็บ EEPROM ที่มีการตั้งค่าไว้

### 2.4 คลิก "Start Auto Download"

1. ตรวจสอบการตั้งค่า (ขั้นที่ 2.2 - 2.3)
2. คลิก **"Start automatic mode"**

### 2.5 เสียบสายเชื่อมต่อและรอสำเร็จ
ทำตามเหมือน [ส่วนที่ 1.6](#16-เสียบสายเชื่อมต่อ-รีเซต-และตรวจสอบ)

> **หมายเหตุ**: การอัพโหลดครั้งต่อไปจะเร็วกว่าครั้งแรก เนื่องจากไม่ต้องลบข้อมูลทั้งชิป

---

## ส่วนที่ 3: เตรียมไฟล์ .bin จาก VS Code

ส่วนนี้อธิบายวิธีการ Build และ Extract ไฟล์ firmware (.bin) จาก VS Code เพื่อนำไปอัพโหลด

### 3.1 Build และ Upload ลองบอร์ดทดลองก่อน

1. เปิด **VS Code** พร้อมโปรเจกต์ PlatformIO
2. ไปที่ **PlatformIO > Run Other tasks** หรือคลิก `Build` 
3. เลือก **Build** เพื่อ compile code
   ```
   pio run
   ```
   หรือใช้ **Upload** เพื่อ build และอัพโหลดทันที
   ```
   pio run -t upload
   ```

4. รอให้ Build สำเร็จ และตรวจสอบ Console ว่าไม่มี Error

### 3.2 ตัวอย่างผลลัพธ์

หลังจาก Build สำเร็จ ไฟล์ firmware จะอยู่ที่:

```
.pio/build/generic/firmware.bin
```

หรือในบางกรณี:

```
build/generic/firmware.bin
```

### 3.3 คัดลอกไฟล์ .bin

1. นำไฟล์ `firmware.bin` ไปวางในโฟลเดอร์ที่จัดเก็บ firmware ต่างๆ เช่น:
   ```
   assets/firmware_stm32f103_v[VERSION]_[DATE].bin
   ```

2. ตั้งชื่อไฟล์ให้ชัดเจน ตัวอย่าง:
   ```
   firmware_stm32f103_v2.0.2_2025-12-17.bin
   ```

3. บันทึก git history หรือ version control เพื่อติดตามเวอร์ชัน

---

